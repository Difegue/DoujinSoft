{% for game in items %}
  
  {% if singleitem != true %}
	<div class="col s12 m6 l4">
  {% else %}
	<div class="col s12 m12 l12"></div>
  {% endif %}
          <div class="card {{ game.colorCart }} darken-2">
            <div class="game-header {{ game.colorLogo }} accent-4">
                <div class="chip game-title" id="{{ game.hash }}-name">
                  {{ game.name }}
                </div>
                <div class="game-metadata black-text">
                  Released {{ game.timestamp }}<br/>
                  MIO-ID: G-{{ game.mioID }}
                </div>
              </div>

            <div class="card-content black-text">

                  <div class="game-data">

                    <div style="width:125px; float:left">

                    {% if game.specialBrand != null %}
                      <div class="brand {{ game.specialBrand }}-brand white-text"></div> 
                    {% else %}
                      <div class="brand game-brand white-text">
                      	{{ game.brand }} <br/>Software
                      </div>  
                    {% endif %}
                    
                      <div class="game-creator black white-text">
                        Made By
                        <div class="white black-text" style="border-radius:0px 0px 10px 10px; font-size:15px; cursor: pointer" onclick="searchForUser('{{ game.creator }}')">
                          {{ game.creator }}
                          </div>
                      </div>

                  </div>

                  <img class ="game-preview z-depth-1 waves-effect tooltipped" style="overflow:hidden; width:100%; height:100%"
                       data-tooltip="Play" onclick="createModal('{{ game.hash }}')" src="{{ game.preview }}" />
                  </div>

              <span class="game-text card-title white-text" style=""><br/>{{ game.mioDesc1 }} <br/>{{ game.mioDesc2 }}</span>          
            </div>

            <div class="card-action center">

              <a class="btn waves-effect tooltipped" data-position="top" data-tooltip="Download" href="./download?type=game&id={{ game.hash }}" style="width:31%" >
                <i class="material-icons">file_download</i>
              </a>
              <a class="btn waves-effect tooltipped" data-position="top" data-delay="50" style=" width:31%" onclick="copyShareLink('games','{{ game.hash }}')" data-tooltip="Get sharing link">
                <i class="material-icons">share</i>
              </a>
              <a class="btn waves-effect tooltipped" data-position="top" data-tooltip="Add to cart" onclick="addToCart('game','{{ game.hash }}')" style="width:31%">
                <i class="material-icons">shopping_cart</i>
              </a>
            </div>
          </div>

        </div>
        
   {% else %}
   
No more games. <br/>
Sad.
       
{% endfor %}
	
<span id="total_items" style="display:none">{{ totalitems }}</span>

<script>

var isInitialised = false;
var mioData = null;

var sounds = [];
var winSounds = [];
var loseSounds = [];

var originalCanvasWidth = 192;
var originalCanvasHeight = 128;
var canvas = document.getElementById('canvas_game');
var context = canvas.getContext('2d');

var hasTrackEnded = false;

scaleCanvas(bestPossibleWindowSize());

// re-scale canvas when the window size changes
window.addEventListener('resize', function () {
  // Expand the canvas so the modal is expanded too.
  canvas.width = 1920;
  canvas.height = 1280;
  scaleCanvas(bestPossibleWindowSize());
});

function modalSize() {
  return [$('#game-modal').width() - 48, $('#game-modal').height() - 108]; // Account for padding
}

function windowSizeComparedToOriginal(width, height) {
  return Math.min(width / originalCanvasWidth, height / originalCanvasHeight);
}

function bestPossibleWindowSize() {
  let [width, height] = modalSize();
  return windowSizeComparedToOriginal(width, height);
}

function createModal(gameHash) {
  $('.modal').modal({
    dismissible: true,
    onCloseEnd: function() {
      context.clearRect(0, 0, canvas.width, canvas.height);
      gameId++;
      player.pause();
    }
  });
  $('#game-modal').modal('open');
  playGame('./download?type=game&id=' + gameHash);
}

async function playGame(url) {
  mioData = await _fetch(url);

  let loopTimes;

  if (mioData[0xE605] === 0) {
    loopTimes = 0;
  } else if (mioData[0xE605] === 1) {
    loopTimes = 1;
  } else {
    loopTimes = 11;
  }
  let midiData = window.buildMidiFile(mioData, loopTimes);

  console.debug(midiData);

  player.load(midiData)

  if (!isInitialised) {

    const loadSound = (name) => {
      let audio = new Audio('audio/' + name + '.ogg');
      audio.volume = 1;
      sounds.push(audio);
      return audio;
    };

    audioNames.forEach(name => {
      let audio = new Audio('audio/' + name + '.ogg');
      audio.volume = 1;
      sounds.push(audio);
    });

    winSounds = [loadSound('win1'), loadSound('win2')];
    loseSounds = [loadSound('lose1'), loadSound('lose2')];

    document.addEventListener('mousemove', handleMouseMove, false);
    canvas.addEventListener('mousedown', handleMouseDown, false);
    document.addEventListener('mouseup', handleMouseUp, false)

    canvas.addEventListener('touchstart', handleTouchStart, false);
    document.addEventListener('touchend', handleTouchEnd, false)

    
    player.on('ended', () => { hasTrackEnded = true; })

    isInitialised = true;
  } 
  
  loadAndStartGame(mioData);
}

function playMusic() {
  player.seek(0);
  player.play();
}

function pauseMusic() {
  player.pause();
}


</script>