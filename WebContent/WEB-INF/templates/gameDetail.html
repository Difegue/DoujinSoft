{% for game in items %}
  
  {% if singleitem != true %}
	<div class="col s12 m6 l4">
  {% else %}
	<div class="col s12 m12 l12"></div>
  {% endif %}
          <div class="card {{ game.colorCart }} darken-2">
            <div class="game-header {{ game.colorLogo }} accent-4">
                <div class="chip game-title" id="{{ game.hash }}-name">
                  {{ game.name }}
                </div>
                <div class="game-metadata black-text">
                  Released {{ game.timestamp }}<br/>
                  MIO-ID: G-{{ game.mioID }}
                </div>
              </div>

            <div class="card-content black-text">

                  <div class="game-data">

                    <div style="width:125px; float:left">

                    {% if game.specialBrand != null %}
                      <div class="brand {{ game.specialBrand }}-brand white-text"></div> 
                    {% else %}
                      <div class="brand game-brand white-text">
                      	{{ game.brand }} <br/>Software
                      </div>  
                    {% endif %}
                    
                      <div class="game-creator black white-text">
                        Made By
                        <div class="white black-text" style="border-radius:0px 0px 10px 10px; font-size:15px; cursor: pointer" onclick="searchForUser('{{ game.creator }}')">
                          {{ game.creator }}
                          </div>
                      </div>

                  </div>

                  <button class ="game-preview z-depth-1 waves-effect tooltipped" data-tooltip="Play" onclick="createModal('{{ game.hash }}')" src="{{ game.preview }}">
                    <img style="overflow:hidden; width:100%; height:100%" data-tooltip="Play" src="{{ game.preview }}"/>
                  </button>
                  </div>

              <span class="game-text card-title white-text" style=""><br/>{{ game.mioDesc1 }} <br/>{{ game.mioDesc2 }}</span>          
            </div>

            <div class="card-action center">

              <a class="btn waves-effect tooltipped" data-position="top" data-tooltip="Download" href="./download?type=game&id={{ game.hash }}" style="width:31%" >
                <i class="material-icons">file_download</i>
              </a>
              <a class="btn waves-effect tooltipped" data-position="top" data-delay="50" style=" width:31%" onclick="copyShareLink('games','{{ game.hash }}')" data-tooltip="Get sharing link">
                <i class="material-icons">share</i>
              </a>
              <a class="btn waves-effect tooltipped" data-position="top" data-tooltip="Add to cart" onclick="addToCart('game','{{ game.hash }}')" style="width:31%">
                <i class="material-icons">shopping_cart</i>
              </a>
            </div>
          </div>

        </div>
        
   {% else %}
   
No more games. <br/>
Sad.
       
{% endfor %}
	
<span id="total_items" style="display:none">{{ totalitems }}</span>

<a class="waves-effect waves-light btn modal-trigger" href="#game-modal">Play</a>

<script src="js/mio-micro/midi-bundle.js"></script>
<script src="js/mio-micro/loader.js"></script>
<script src="js/mio-micro/player.js"></script>

<script>

const musicPlayer = window.timidity('js/timidity');

let mioData = null;

var originalCanvasWidth = 192;
var originalCanvasHeight = 128;
var canvas = document.getElementById('canvas_game');
var context = canvas.getContext('2d');

scaleCanvas(bestPossibleWindowSize());

// re-scale canvas when the window size changes
window.addEventListener('resize', function () {
  scaleCanvas(bestPossibleWindowSize());
});

function modalSize() {
  return [$('#game-modal').width() - 48, $('#game-modal').height() - 48]; // Account for padding
}

function windowSizeComparedToOriginal(width, height) {
  return Math.min(width / originalCanvasWidth, height / originalCanvasHeight);
}

function bestPossibleWindowSize() {
  let [width, height] = modalSize();
  return windowSizeComparedToOriginal(width, height);
}

function createModal(gameHash) {
  $('.modal').modal({
    dismissible: true,
    onCloseEnd: function() {
      gameId++;
      musicPlayer.pause();
    }
  });
  $('#game-modal').modal('open');
  playGame('./download?type=game&id=' + gameHash);
}

async function playGame(url) {
  mioData = await _fetch(url);

  let midiData = window.buildMidiFile(mioData);

  musicPlayer.load(midiData)

  // TODO: This is supposed to loop the music but it's not working
  musicPlayer.on('ended', () => { console.debug('music ended'); musicPlayer.play() })

  musicPlayer.play();

  loadAndStartGame(mioData);
}


</script>